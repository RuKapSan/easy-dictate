# E2E Test Infrastructure - Critical Fixes

## FIX 1: PowerShell String Injection Vulnerability
File: audio-mock.ts, Lines 181-211
Severity: CRITICAL

Problem: Audio text with $ character breaks PowerShell script
Example: "Cost is $50" causes PowerShell variable expansion error

Solution: Escape single quotes for PowerShell string literals
const escapedText = text.replace(/'/g, "''");
Then use: $synth.Speak('${escapedText}') instead of double quotes

---

## FIX 2: Audio Injection Timing Race Condition
File: app.spec.ts, Lines 345-352, 316-340, 367-387
Severity: CRITICAL

Problem: Hardcoded 500ms pause assumes microphone is ready
On slow machines, audio injection happens before recording starts

Solution: Replace:
await pressGlobalHotkey(hotkey);
await browser.pause(500);

With:
await pressGlobalHotkey(hotkey);
await browser.waitForStatus('recording', 5000);

Apply to ALL audio injection tests

---

## FIX 3: Zombie FFplay Process Leak
File: audio-mock.ts, Lines 99-146
Severity: CRITICAL

Problem: If Node process dies, ffplay.exe remains running
Audio device locked for next test run

Solutions:
1. Add detached: false to spawn options
2. Add timeout cleanup (max 120 seconds)
3. Add process.on('exit') hook to kill ffplay
4. Force kill with SIGKILL if SIGTERM doesn't work

---

## FIX 4: Blocking Audio Playback
File: audio-mock.ts, Line 153
Severity: MEDIUM

Problem: PlaySync() blocks until audio finishes
Cannot test "stop during speech" scenarios

Solution: Use Play() instead of PlaySync()
This lets audio play non-blocking

---

## FIX 5: Windows Path Escaping
File: hotkey-tester.ts:106, audio-mock.ts:152
Severity: LOW

Problem: Paths with spaces may break in PowerShell

Solution: Use proper escaping:
const escapedPath = path.replace(/'/g, "''");
Then use in PowerShell: '${escapedPath}'

---

## HIGH PRIORITY IMPROVEMENTS

1. Replace ALL browser.pause() with state waiters
   8+ places in app.spec.ts
   Use: waitForStatus(), waitUntil()

2. Externalize PowerShell scripts to .ps1 files
   Enables syntax highlighting and testing

3. Implement console error capture
   Add console interception in before() hook

---

ESTIMATED TIME TO FIX ALL CRITICAL ISSUES: 1.5 hours
